<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uni-Link プロトタイプ (高専版)</title>
    <style>
        /* CSSスタイルは変更ありません */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #0056b3; }
        .screen { display: none; }
        .screen.active { display: block; }
        input[type="email"], input[type="text"], input[type="password"], select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; }
        button:hover { background-color: #0056b3; }
        .secondary-button { background-color: #6c757d; margin-top: 10px; }
        .secondary-button:hover { background-color: #5a6268; }
        .logout-button { background-color: #dc3545; width: auto; float: right;}
        .user-list, .match-list { list-style: none; padding: 0; }
        .user-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; background: #fff; }
        .user-card h3 { margin-top: 0; }
        .user-card .tags { margin-top: 10px; }
        .tag { display: inline-block; background-color: #e9ecef; color: #495057; padding: 3px 8px; margin: 2px; border-radius: 12px; font-size: 14px; }
        nav { display: flex; justify-content: space-around; border-bottom: 2px solid #007bff; margin-bottom: 20px; }
        nav button { background: none; border: none; color: #007bff; padding: 15px; font-size: 16px; cursor: pointer; width: 33.3%; border-radius: 0; }
        nav button.active { border-bottom: 3px solid #0056b3; font-weight: bold; }
        #profile-interests-editor { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        #profile-interests-editor label { display: flex; align-items: center; cursor: pointer; padding: 5px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <!-- ▼▼▼ HTMLの入力欄を変更 ▼▼▼ -->
        <div id="login-screen" class="screen active">
            <h1>Uni-Link</h1>
            <h2>高専内交流促進アプリ</h2>
            <!-- typeを"email", placeholderを"学校のメールアドレス"に変更 -->
            <input type="email" id="login-id" placeholder="学校のメールアドレス">
            <input type="password" id="login-password" placeholder="パスワード">
            <button onclick="handleLogin()">ログイン</button>
            <button class="secondary-button" onclick="showScreen('register-screen')">新規登録はこちら</button>
        </div>

        <div id="register-screen" class="screen">
            <h1>新規登録</h1>
            <!-- typeを"email", placeholderを"学校のメールアドレス"に変更 -->
            <input type="email" id="register-id" placeholder="学校のメールアドレス (例: s20c123@s.akashi.ac.jp)">
            <input type="password" id="register-password" placeholder="パスワード">
            <input type="text" id="register-name" placeholder="ニックネーム">
            <select id="register-faculty">
                <option value="M科">M科 (機械工学科)</option>
                <option value="E科">E科 (電気電子工学科)</option>
                <option value="C科">C科 (情報工学科)</option>
                <option value="A科">A科 (物質化学工学科)</option>
            </select>
            <select id="register-grade">
                <option value="1年">1年</option>
                <option value="2年">2年</option>
                <option value="3年">3年</option>
                <option value="4年">4年</option>
                <option value="5年">5年</option>
                <option value="専攻科1年">専攻科1年</option>
                <option value="専攻科2年">専攻科2年</option>
            </select>
            <button onclick="handleRegister()">登録する</button>
            <button class="secondary-button" onclick="showScreen('login-screen')">ログイン画面に戻る</button>
        </div>
        <!-- ▲▲▲ HTMLの入力欄を変更 ▲▲▲ -->

        <div id="main-screen" class="screen">
            <button class="logout-button" onclick="handleLogout()">ログアウト</button>
            <h1 id="welcome-message">ようこそ！</h1>
            
            <nav>
                <button id="nav-users" class="active" onclick="showTab('users')">ユーザー一覧</button>
                <button id="nav-matches" onclick="showTab('matches')">マッチング一覧</button>
                <button id="nav-profile" onclick="showTab('profile')">プロフィール編集</button>
            </nav>

            <div id="users-tab">
                <ul id="user-list" class="user-list"></ul>
            </div>

            <div id="matches-tab" style="display: none;">
                <h2>マッチング成立！</h2>
                <p>相互に「いいね」したユーザーです。学内SNSやTeamsなどで連絡を取ってみましょう！</p>
                <ul id="match-list" class="match-list"></ul>
            </div>

            <div id="profile-tab" style="display: none;">
                <h2>プロフィール編集</h2>
                <p><strong>興味・関心タグ（複数選択可）</strong></p>
                <div id="profile-interests-editor"></div>
                <button onclick="updateProfile()">プロフィールを更新</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK (Software Development Kit) を読み込む -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // Firebase の初期化（あなたの設定に置き換えてください）
        const firebaseConfig = {
          apiKey: "AIzaSyAcKf5BrhFFkv74WdaamqnrCY1qSRxsVjE",
          authDomain: "deaikei-kosen.firebaseapp.com",
          projectId: "deaikei-kosen",
          storageBucket: "deaikei-kosen.firebasestorage.app",
          messagingSenderId: "166298285211",
          appId: "1:166298285211:web:5381e5e419754e0376c23e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>

    <script>
        // ===============================================
        // アプリケーションのメインJavaScript
        // ===============================================
        let loggedInUserId = null;
        
        const allInterests = [
            "プログラミング", "機械学習", "電子工作", "設計", "実験", "ロボコン",
            "デザイン", "映像制作", "バスケ", "サッカー", "テニス", "音楽", "バンド",
            "TOIC勉強中", "論文執筆", "起業したい", "ボランティア", "バイク"
        ];

        // ログイン状態の監視
        auth.onAuthStateChanged(user => {
            if (user) {
                loggedInUserId = user.uid;
                showScreen('main-screen');
                renderMainScreen();
            } else {
                loggedInUserId = null;
                showScreen('login-screen');
            }
        });

        // 画面・タブ切り替え
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showTab(tabId) {
            ['users-tab', 'matches-tab', 'profile-tab'].forEach(id => document.getElementById(id).style.display = 'none');
            document.getElementById(`${tabId}-tab`).style.display = 'block';

            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`nav-${tabId}`).classList.add('active');

            if (tabId === 'users') renderUsers();
            if (tabId === 'matches') renderMatches();
            if (tabId === 'profile') renderProfileEditor();
        }

        // ===============================================
        // ユーザー認証関連 (新要件対応版)
        // ===============================================
        function handleRegister() {
            const email = document.getElementById('register-id').value.trim();
            const password = document.getElementById('register-password').value;
            const name = document.getElementById('register-name').value;
            const faculty = document.getElementById('register-faculty').value;
            const grade = document.getElementById('register-grade').value;

            if (!email || !password || !name) {
                alert('メールアドレス, パスワード, ニックネームは必須です。');
                return;
            }

            // ★★★ 要件: @s.akashi.ac.jp で終わるメールアドレスかチェック ★★★
            if (!email.endsWith('@s.akashi.ac.jp')) {
                alert('登録できるのは "@s.akashi.ac.jp" のメールアドレスのみです。');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    const studentId = email.split('@')[0]; // メールアドレスから学籍番号を抽出

                    db.collection('users').doc(user.uid).set({
                        uid: user.uid,
                        studentId: studentId,
                        name: name,
                        faculty: faculty,
                        grade: grade,
                        interests: []
                    })
                    .then(() => {
                        alert('登録が完了しました！ログインしてください。');
                        showScreen('login-screen');
                    });
                })
                .catch(error => alert('登録に失敗しました。\n' + error.message));
        }

        function handleLogin() {
            // ★★★ 要件: 完全なメールアドレスでログイン ★★★
            const email = document.getElementById('login-id').value.trim();
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                alert('メールアドレスとパスワードを入力してください。');
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => alert('メールアドレスまたはパスワードが間違っています。\n' + error.message));
        }

        function handleLogout() {
            auth.signOut();
        }

        // メイン画面の描画処理
        function renderMainScreen() {
            db.collection('users').doc(loggedInUserId).get().then(doc => {
                if (doc.exists) {
                    document.getElementById('welcome-message').textContent = `ようこそ、${doc.data().name}さん！`;
                }
            });
            showTab('users');
        }

        // ★★★注意★★★
        // これ以降の関数はまだ正しく動作しません。次のステップでFirestoreを使うように書き換えます。
        function renderUsers() {
            document.getElementById('user-list').innerHTML = "<p>ユーザー情報を読み込み中...</p>";
        }
        function renderMatches() {
            document.getElementById('match-list').innerHTML = "<p>マッチング情報を読み込み中...</p>";
        }
        function renderProfileEditor() {
            document.getElementById('profile-interests-editor').innerHTML = "<p>プロフィール情報を読み込み中...</p>";
        }
        function handleLike(targetUserId) {
            alert("「いいね」機能は次のステップで実装します。");
        }
        function updateProfile() {
             alert("プロフィール更新機能は次のステップで実装します。");
        }
    </script>
</body>
</html>
