<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uni-Link ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ— (é«˜å°‚ç‰ˆ)</title>
    <style>
        /* CSSã¯ã»ã¼å¤‰æ›´ãªã— */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #0056b3; }
        p.description { text-align: center; color: #6c757d; font-size: 0.9em; }
        .screen { display: none; }
        .screen.active { display: block; }
        input[type="email"], input[type="text"], input[type="password"], select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .secondary-button { background-color: #6c757d; margin-top: 10px; }
        .secondary-button:hover { background-color: #5a6268; }
        .logout-button { background-color: #dc3545; width: auto; float: right;}
        .user-list, .match-list { list-style: none; padding: 0; }
        .user-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; background: #fff; }
        .user-card h3 { margin-top: 0; }
        .user-card .tags { margin-top: 10px; }
        .tag { display: inline-block; background-color: #e9ecef; color: #495057; padding: 3px 8px; margin: 2px; border-radius: 12px; font-size: 14px; }
        nav { display: flex; justify-content: space-around; border-bottom: 2px solid #007bff; margin-bottom: 20px; }
        nav button { background: none; border: none; color: #007bff; padding: 15px; font-size: 16px; cursor: pointer; width: 33.3%; border-radius: 0; }
        nav button.active { border-bottom: 3px solid #0056b3; font-weight: bold; }
        #profile-interests-editor { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        #profile-interests-editor label { display: flex; align-items: center; cursor: pointer; padding: 5px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <!-- â–¼â–¼â–¼ ãƒ­ã‚°ã‚¤ãƒ³/ç™»éŒ²ç”»é¢ã‚’çµ±åˆãƒ»ç°¡ç•¥åŒ– â–¼â–¼â–¼ -->
        <div id="login-screen" class="screen active">
            <h1>Uni-Link</h1>
            <h2>é«˜å°‚å†…äº¤æµä¿ƒé€²ã‚¢ãƒ—ãƒª</h2>
            <p class="description">å­¦æ ¡ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>èªè¨¼ç”¨ã®ãƒªãƒ³ã‚¯ã‚’ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡ã—ã¾ã™ã€‚</p>
            <input type="email" id="email-input" placeholder="å­¦æ ¡ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹">
            <button onclick="sendSignInLink()">èªè¨¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡</button>
        </div>

        <!-- â–¼â–¼â–¼ åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šç”»é¢ã‚’æ–°è¨­ â–¼â–¼â–¼ -->
        <div id="profile-setup-screen" class="screen">
            <h1>ã‚ˆã†ã“ãï¼</h1>
            <p class="description">åˆå›ç™»éŒ²ã®ãŸã‚ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
            <input type="text" id="register-name" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ">
            <select id="register-faculty">
                <option value="æ©Ÿæ¢°å·¥å­¦ç§‘">Mç§‘ (æ©Ÿæ¢°å·¥å­¦ç§‘)</option>
                <option value="é›»æ°—æƒ…å ±å·¥å­¦ç§‘">Eç§‘ (é›»æ°—æƒ…å ±å·¥å­¦ç§‘)</option>
                <option value="éƒ½å¸‚ã‚·ã‚¹ãƒ†ãƒ å·¥å­¦ç§‘">Cç§‘ (éƒ½å¸‚ã‚·ã‚¹ãƒ†ãƒ å·¥å­¦ç§‘)</option>
                <option value="å»ºç¯‰å­¦ç§‘">Aç§‘ (å»ºç¯‰å­¦ç§‘)</option>
            </select>
            <select id="register-grade">
                <option value="1å¹´">1å¹´</option><option value="2å¹´">2å¹´</option><option value="3å¹´">3å¹´</option><option value="4å¹´">4å¹´</option><option value="5å¹´">5å¹´</option><option value="å°‚æ”»ç§‘1å¹´">å°‚æ”»ç§‘1å¹´</option><option value="å°‚æ”»ç§‘2å¹´">å°‚æ”»ç§‘2å¹´</option>
            </select>
            <button onclick="handleProfileSetup()">ç™»éŒ²ã—ã¦åˆ©ç”¨ã‚’é–‹å§‹ã™ã‚‹</button>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ï¼ˆå¤‰æ›´ãªã—ï¼‰ -->
        <div id="main-screen" class="screen">
            <button class="logout-button" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            <h1 id="welcome-message">ã‚ˆã†ã“ãï¼</h1>
            <nav>
                <button id="nav-users" class="active" onclick="showTab('users')">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</button>
                <button id="nav-matches" onclick="showTab('matches')">ãƒãƒƒãƒãƒ³ã‚°ä¸€è¦§</button>
                <button id="nav-profile" onclick="showTab('profile')">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</button>
            </nav>
            <div id="users-tab"><ul id="user-list" class="user-list"></ul></div>
            <div id="matches-tab" style="display: none;"><h2>ãƒãƒƒãƒãƒ³ã‚°æˆç«‹ï¼</h2><p>ç›¸äº’ã«ã€Œã„ã„ã­ã€ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã™ã€‚</p><ul id="match-list" class="match-list"></ul></div>
            <div id="profile-tab" style="display: none;">
                <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†</h2>
                <p><strong>èˆˆå‘³ãƒ»é–¢å¿ƒã‚¿ã‚°</strong></p>
                <div id="profile-interests-editor"></div><button onclick="updateProfile()">èˆˆå‘³ã‚¿ã‚°ã‚’æ›´æ–°</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyAcKf5BrhFFkv74WdaamqnrCY1qSRxsVjE",
          authDomain: "deaikei-kosen.firebaseapp.com",
          projectId: "deaikei-kosen",
          storageBucket: "deaikei-kosen.firebasestorage.app",
          messagingSenderId: "166298285211",
          appId: "1:166298285211:web:5381e5e419754e0376c23e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>
    <script>
        // ===============================================
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¡ã‚¤ãƒ³JavaScript
        // ===============================================
        let loggedInUserId = null;
        const allInterests = ["ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", "æ©Ÿæ¢°å­¦ç¿’", "é›»å­å·¥ä½œ", "è¨­è¨ˆ", "å®Ÿé¨“", "ãƒ­ãƒœã‚³ãƒ³", "ãƒ‡ã‚¶ã‚¤ãƒ³", "æ˜ åƒåˆ¶ä½œ", "ãƒã‚¹ã‚±", "ã‚µãƒƒã‚«ãƒ¼", "ãƒ†ãƒ‹ã‚¹", "éŸ³æ¥½", "ãƒãƒ³ãƒ‰", "TOICå‹‰å¼·ä¸­", "è«–æ–‡åŸ·ç­†", "èµ·æ¥­ã—ãŸã„", "ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢", "ãƒã‚¤ã‚¯"];
        
        // â–¼â–¼â–¼ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†ã‚’ãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯èªè¨¼ç”¨ã«å¤‰æ›´ â–¼â–¼â–¼
        window.onload = function() {
            // ãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‹ãƒã‚§ãƒƒã‚¯
            if (auth.isSignInWithEmailLink(window.location.href)) {
                let email = window.localStorage.getItem('emailForSignIn');
                if (!email) {
                    // ä½•ã‚‰ã‹ã®ç†ç”±ã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒä¿å­˜ã•ã‚Œã¦ã„ãªã„å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å†å…¥åŠ›ã‚’ä¿ƒã™
                    email = window.prompt('èªè¨¼ã‚’å®Œäº†ã™ã‚‹ãŸã‚ã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å†åº¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                }
                
                // ãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯ã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã‚’å®Œäº†ã•ã›ã‚‹
                auth.signInWithEmailLink(email, window.location.href)
                    .then(async (result) => {
                        window.localStorage.removeItem('emailForSignIn'); // ä¸€æ™‚ä¿å­˜ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚’å‰Šé™¤
                        const user = result.user;
                        
                        // ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–°è¦ç™»éŒ²ã‹ã©ã†ã‹ã‚’Firestoreã§ç¢ºèª
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (!userDoc.exists) {
                            // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã®ã§ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šç”»é¢ã‚’è¡¨ç¤º
                            showScreen('profile-setup-screen');
                        } else {
                            // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã®ã§ã€ãƒ¡ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤ºï¼ˆonAuthStateChangedãŒå¾Œã§å‡¦ç†ï¼‰
                        }
                    })
                    .catch(error => alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message));
            }
        };

        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–ï¼ˆå¤‰æ›´ãªã—ï¼‰
        auth.onAuthStateChanged(user => {
            if (user) {
                loggedInUserId = user.uid;
                // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒã¾ã è¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€onAuthStateChangedã§ã¯ä½•ã‚‚ã—ãªã„
                db.collection('users').doc(user.uid).get().then(doc => {
                    if(doc.exists) {
                        showScreen('main-screen');
                        renderMainScreen();
                    }
                });
            } else {
                loggedInUserId = null;
                showScreen('login-screen');
            }
        });

        // â–¼â–¼â–¼ èªè¨¼ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹é–¢æ•° â–¼â–¼â–¼
        function sendSignInLink() {
            const email = document.getElementById('email-input').value.replace(/\s/g, '');
            if (!email) {
                alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return;
            }
            if (!email.endsWith('@s.akashi.ac.jp')) {
                alert('ç™»éŒ²ã§ãã‚‹ã®ã¯ "@s.akashi.ac.jp" ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿ã§ã™ã€‚'); return;
            }

            const actionCodeSettings = {
                url: window.location.href, // èªè¨¼å¾Œã«æˆ»ã£ã¦ãã‚‹URL
                handleCodeInApp: true
            };

            auth.sendSignInLinkToEmail(email, actionCodeSettings)
                .then(() => {
                    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚å¤§ä¸ˆå¤«ãªã‚ˆã†ã«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä¿å­˜
                    window.localStorage.setItem('emailForSignIn', email);
                    alert(`èªè¨¼ç”¨ã®ãƒªãƒ³ã‚¯ã‚’ ${email} ã«é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
                })
                .catch(error => alert('ãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message));
        }

        // â–¼â–¼â–¼ åˆå›ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç™»éŒ²ã™ã‚‹é–¢æ•° â–¼â–¼â–¼
        function handleProfileSetup() {
            const currentUser = auth.currentUser;
            if (!currentUser) {
                alert('ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'); return;
            }
            
            const name = document.getElementById('register-name').value.trim();
            const faculty = document.getElementById('register-faculty').value;
            const grade = document.getElementById('register-grade').value;

            if (!name) { alert('ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

            db.collection('users').doc(currentUser.uid).set({
                uid: currentUser.uid, name: name, faculty: faculty,
                grade: grade, interests: []
            }).then(() => {
                alert('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                showScreen('main-screen');
                renderMainScreen(); // ãƒ¡ã‚¤ãƒ³ç”»é¢ã®æç”»ã‚’ã‚­ãƒƒã‚¯
            }).catch(error => alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message));
        }
        
        function handleLogout() { auth.signOut(); }
        function renderMainScreen() { /* ... å¤‰æ›´ãªã— ... */ }
        function renderUsers() { /* ... å¤‰æ›´ãªã— ... */ }
        async function handleLike(targetUserId) { /* ... å¤‰æ›´ãªã— ... */ }
        async function renderMatches() { /* ... å¤‰æ›´ãªã— ... */ }
        function renderProfileEditor() { /* ... å¤‰æ›´ãªã— ... */ }
        function updateProfile() { /* ... å¤‰æ›´ãªã— ... */ }

        // çœç•¥ã—ãŸé–¢æ•°ã®æœ¬ä½“ï¼ˆã‚³ãƒ”ãƒ¼ç”¨ï¼‰
        function showScreen(screenId) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(screenId).classList.add('active'); }
        function showTab(tabId) { ['users-tab', 'matches-tab', 'profile-tab'].forEach(id => document.getElementById(id).style.display = 'none'); document.getElementById(`${tabId}-tab`).style.display = 'block'; document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active')); document.getElementById(`nav-${tabId}`).classList.add('active'); if (tabId === 'users') renderUsers(); if (tabId === 'matches') renderMatches(); if (tabId === 'profile') renderProfileEditor(); }
        function renderMainScreen() { db.collection('users').doc(loggedInUserId).get().then(doc => { if (doc.exists) { document.getElementById('welcome-message').textContent = `ã‚ˆã†ã“ãã€${doc.data().name}ã•ã‚“ï¼`; } }); showTab('users'); }
        function renderUsers() { const userList = document.getElementById('user-list'); userList.innerHTML = "<p>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>"; db.collection('likes').where('from', '==', loggedInUserId).get().then(likeSnapshot => { const myLikes = likeSnapshot.docs.map(doc => doc.data().to); db.collection('users').onSnapshot(snapshot => { userList.innerHTML = ''; snapshot.forEach(doc => { const user = doc.data(); if (user.uid === loggedInUserId) return; const iLiked = myLikes.includes(user.uid); const card = document.createElement('li'); card.className = 'user-card'; card.innerHTML = `<h3>${user.name} <small>(${user.faculty}ãƒ»${user.grade})</small></h3><div class="tags">${(user.interests || []).map(tag => `<span class="tag">${tag}</span>`).join('')}</div><button onclick="handleLike('${user.uid}')" ${iLiked ? 'disabled' : ''}>${iLiked ? 'âœ… ã„ã„ã­æ¸ˆã¿' : 'ğŸ‘ ã„ã„ã­ï¼'}</button>`; userList.appendChild(card); }); }); }); }
        async function handleLike(targetUserId) { await db.collection('likes').add({ from: loggedInUserId, to: targetUserId }); renderUsers(); const query = db.collection('likes').where('from', '==', targetUserId).where('to', '==', loggedInUserId); const result = await query.get(); if (!result.empty) { const targetUserData = await db.collection('users').doc(targetUserId).get(); alert(`ğŸ‰ ${targetUserData.data().name}ã•ã‚“ã¨ãƒãƒƒãƒãƒ³ã‚°ã—ã¾ã—ãŸï¼`); } }
        async function renderMatches() { const matchList = document.getElementById('match-list'); matchList.innerHTML = "<p>ãƒãƒƒãƒãƒ³ã‚°æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>"; const myLikesSnapshot = await db.collection('likes').where('from', '==', loggedInUserId).get(); const myLikesIds = myLikesSnapshot.docs.map(doc => doc.data().to); const likedBySnapshot = await db.collection('likes').where('to', '==', loggedInUserId).get(); const likedByIds = likedBySnapshot.docs.map(doc => doc.data().from); const matchedIds = myLikesIds.filter(id => likedByIds.includes(id)); if (matchedIds.length === 0) { matchList.innerHTML = '<p>ã¾ã ãƒãƒƒãƒãƒ³ã‚°ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã„ã¾ã›ã‚“ã€‚</p>'; return; } const usersSnapshot = await db.collection('users').where('uid', 'in', matchedIds).get(); matchList.innerHTML = ''; usersSnapshot.forEach(doc => { const user = doc.data(); const card = document.createElement('li'); card.className = 'user-card'; card.innerHTML = `<h3>${user.name} <small>(${user.faculty}ãƒ»${user.grade})</small></h3><div class="tags">${(user.interests || []).map(tag => `<span class="tag">${tag}</span>`).join('')}</div>`; matchList.appendChild(card); }); }
        function renderProfileEditor() { const editor = document.getElementById('profile-interests-editor'); editor.innerHTML = "<p>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>"; db.collection('users').doc(loggedInUserId).get().then(doc => { if (!doc.exists) return; const myInterests = doc.data().interests || []; editor.innerHTML = ''; allInterests.forEach(interest => { const isChecked = myInterests.includes(interest); editor.innerHTML += `<label><input type="checkbox" value="${interest}" ${isChecked ? 'checked' : ''}>${interest}</label>`; }); }); }
        function updateProfile() { const selectedInterests = []; document.querySelectorAll('#profile-interests-editor input:checked').forEach(c => selectedInterests.push(c.value)); db.collection('users').doc(loggedInUserId).update({ interests: selectedInterests }).then(() => { alert('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼'); showTab('users'); }).catch(error => alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message)); }
    </script>
</body>
</html>
