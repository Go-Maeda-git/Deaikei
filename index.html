<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>孤選 (Kosen)</title>
    <style>
        /* CSSはほぼ変更なし、アバター選択用のスタイルを追加 */
        :root { --theme-pink: #FD3A73; --bg-dark: #121212; --card-dark: #242424; --text-light: #FFFFFF; --text-muted: #B3B3B3; }
        html, body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-dark); color: var(--text-light); overflow: hidden; width: 100%; height: 100%; }
        * { box-sizing: border-box; }
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }
        .app-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; overflow: hidden; }
        #card-stack { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .profile-card { position: absolute; width: 90vw; max-width: 380px; height: 75vh; max-height: 600px; background: var(--card-dark); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); overflow: hidden; display: flex; flex-direction: column; justify-content: flex-end; }
        .profile-pic { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        .profile-info { position: relative; z-index: 2; padding: 25px; background: linear-gradient(to top, rgba(0,0,0,0.95) 30%, transparent); }
        .profile-header { display: flex; justify-content: space-between; align-items: center; }
        .profile-info h3 { font-size: 28px; margin: 0; }
        .profile-info p { font-size: 18px; margin: 5px 0 10px; color: var(--text-muted); }
        .profile-tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .profile-tag { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 15px; padding: 5px 12px; font-size: 14px; }
        .actions { display: flex; justify-content: space-evenly; align-items: center; padding: 15px 0; }
        .action-btn { background: var(--card-dark); border: 1px solid #444; border-radius: 50%; width: 70px; height: 70px; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: transform 0.2s; }
        .action-btn:hover { transform: scale(1.1); }
        .action-btn svg { width: 35px; height: 35px; }
        .nope svg { stroke: #FD5068; }
        .like svg { stroke: #2DB97B; }
        #no-more-cards { text-align: center; color: var(--text-muted); }
        .report-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 5px; }
        nav { width: 100%; background: var(--card-dark); display: flex; justify-content: space-around; padding: 5px 0; border-top: 1px solid #333; }
        nav button { background: none; border: none; cursor: pointer; color: #777; padding: 10px; }
        nav button.active { color: var(--theme-pink); }
        nav svg { width: 28px; height: 28px; }
        .login-container { flex-grow: 1; justify-content: center; align-items: center; padding: 20px; text-align: center; }
        .login-container h1 { font-size: 48px; font-weight: bold; letter-spacing: 2px; }
        .login-container p { color: var(--text-muted); }
        .login-container input, .login-container select { width: 100%; max-width: 300px; border-radius: 25px; text-align: center; background-color: var(--card-dark); color: var(--text-light); border: 1px solid #444; padding: 12px; margin-bottom: 10px;}
        .login-container button { width: 100%; max-width: 300px; border-radius: 25px; background: linear-gradient(90deg, #FD297B, #FF655B); border: none; padding: 12px; color: white; font-weight: bold; }
        .list-container { flex-grow: 1; overflow-y: auto; padding: 20px 20px 80px; }
        .list-container h2 { color: var(--theme-pink); }
        .match-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #333; }
        .match-avatar { width: 60px; height: 60px; border-radius: 50%; background-color: #333; margin-right: 15px; object-fit: cover; }
        .profile-edit-section { margin-bottom: 2em; }
        .profile-edit-section button { background: var(--theme-pink); border: none; padding: 12px; font-weight: bold; border-radius: 25px; }
        .profile-edit-section .delete-button { background: #dc3545; }
        .profile-edit-section .logout-button { background: #6c757d; }
        /* ▼▼▼ アバター選択用のスタイルを追加 ▼▼▼ */
        #avatar-selection-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 300px; margin: 1em auto; }
        .avatar-option { width: 100%; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: border-color 0.2s; }
        .avatar-option.selected { border-color: var(--theme-pink); }
    </style>
</head>
<body>
    <div id="login-screen" class="screen active"><div class="login-container"><h1>孤選</h1><p>学校のメールアドレスでログイン/登録</p><input type="email" id="email-input" placeholder="sXXXXX@s.akashi.ac.jp"><button onclick="sendSignInLink()">認証メールを送信</button></div></div>
    
    <!-- ▼▼▼ プロフィール設定画面のHTMLをアバター選択式に変更 ▼▼▼ -->
    <div id="profile-setup-screen" class="screen">
        <div class="login-container">
            <h1>ようこそ！</h1><p>はじめにプロフィールを設定してください</p>
            <p style="font-size: 0.9em; margin-top: 1.5em;">好きなアバターを選んでください</p>
            <div id="avatar-selection-grid">
                <!-- アバター画像がJSでここに挿入されます -->
            </div>
            <input type="text" id="register-name" placeholder="ニックネーム">
            <select id="register-faculty"><option value="機械工学科">M科</option><option value="電気情報工学科">E科</option><option value="都市システム工学科">C科</option><option value="建築学科">A科</option></select>
            <select id="register-grade"><option value="1年">1年</option><option value="2年">2年</option><option value="3年">3年</option><option value="4年">4年</option><option value="5年">5年</option><option value="専攻科1年">専攻科1年</option><option value="専攻科2年">専攻科2年</option></select>
            <button onclick="handleProfileSetup()" id="setup-button">登録して利用を開始する</button>
        </div>
    </div>

    <!-- 他のHTML部分は変更なし -->
    <div id="main-screen" class="screen"><div class="app-container"><div id="card-stack"></div><div id="actions-area" class="actions"><div class="action-btn nope" onclick="handleNope()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></div><div class="action-btn like" onclick="handleLikeClick()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg></div></div></div><nav id="main-nav"></nav></div>
    <div id="matches-screen" class="screen"><div class="list-container"><h2>マッチング一覧</h2><div id="match-list"></div></div><nav id="matches-nav"></nav></div>
    <div id="profile-screen" class="screen"><div class="list-container"><div class="profile-edit-section"><h2>プロフィール編集</h2><div id="profile-interests-editor"></div><button onclick="updateProfile()">興味タグを更新</button></div><div class="profile-edit-section"><h2>アカウント設定</h2><button class="logout-button" onclick="handleLogout()">ログアウト</button><button class="delete-button" onclick="handleDeleteAccount()">アカウントを完全に削除する</button></div></div><nav id="profile-nav"></nav></div>
    
    <!-- ▼▼▼ Firebase Storageのスクリプトを削除 ▼▼▼ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = { apiKey: "AIzaSyAcKf5BrhFFkv74WdaamqnrCY1qSRxsVjE", authDomain: "deaikei-kosen.firebaseapp.com", projectId: "deaikei-kosen", storageBucket: "deaikei-kosen.firebasestorage.app", messagingSenderId: "166298285211", appId: "1:166298285211:web:5381e5e419754e0376c23e" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        // const storage = firebase.storage(); // Storageは不要なので削除
    </script>
    <s
