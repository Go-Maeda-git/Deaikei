<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uni-Link プロトタイプ (高専版)</title>
    <style>
        /* CSSはほぼ変更なし */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #0056b3; }
        p.description { text-align: center; color: #6c757d; font-size: 0.9em; }
        .screen { display: none; }
        .screen.active { display: block; }
        input[type="email"], input[type="text"], input[type="password"], select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .secondary-button { background-color: #6c757d; margin-top: 10px; }
        .secondary-button:hover { background-color: #5a6268; }
        .logout-button { background-color: #dc3545; width: auto; float: right;}
        .user-list, .match-list { list-style: none; padding: 0; }
        .user-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; background: #fff; }
        .user-card h3 { margin-top: 0; }
        .user-card .tags { margin-top: 10px; }
        .tag { display: inline-block; background-color: #e9ecef; color: #495057; padding: 3px 8px; margin: 2px; border-radius: 12px; font-size: 14px; }
        nav { display: flex; justify-content: space-around; border-bottom: 2px solid #007bff; margin-bottom: 20px; }
        nav button { background: none; border: none; color: #007bff; padding: 15px; font-size: 16px; cursor: pointer; width: 33.3%; border-radius: 0; }
        nav button.active { border-bottom: 3px solid #0056b3; font-weight: bold; }
        #profile-interests-editor { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        #profile-interests-editor label { display: flex; align-items: center; cursor: pointer; padding: 5px; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <!-- ▼▼▼ ログイン/登録画面を統合・簡略化 ▼▼▼ -->
        <div id="login-screen" class="screen active">
            <h1>Uni-Link</h1>
            <h2>高専内交流促進アプリ</h2>
            <p class="description">学校のメールアドレスを入力してください。<br>認証用のリンクをメールで送信します。</p>
            <input type="email" id="email-input" placeholder="学校のメールアドレス">
            <button onclick="sendSignInLink()">認証メールを送信</button>
        </div>

        <!-- ▼▼▼ 初回ログイン時のプロフィール設定画面を新設 ▼▼▼ -->
        <div id="profile-setup-screen" class="screen">
            <h1>ようこそ！</h1>
            <p class="description">初回登録のため、プロフィールを設定してください。</p>
            <input type="text" id="register-name" placeholder="ニックネーム">
            <select id="register-faculty">
                <option value="機械工学科">M科 (機械工学科)</option>
                <option value="電気情報工学科">E科 (電気情報工学科)</option>
                <option value="都市システム工学科">C科 (都市システム工学科)</option>
                <option value="建築学科">A科 (建築学科)</option>
            </select>
            <select id="register-grade">
                <option value="1年">1年</option><option value="2年">2年</option><option value="3年">3年</option><option value="4年">4年</option><option value="5年">5年</option><option value="専攻科1年">専攻科1年</option><option value="専攻科2年">専攻科2年</option>
            </select>
            <button onclick="handleProfileSetup()">登録して利用を開始する</button>
        </div>

        <!-- メイン画面（変更なし） -->
        <div id="main-screen" class="screen">
            <button class="logout-button" onclick="handleLogout()">ログアウト</button>
            <h1 id="welcome-message">ようこそ！</h1>
            <nav>
                <button id="nav-users" class="active" onclick="showTab('users')">ユーザー一覧</button>
                <button id="nav-matches" onclick="showTab('matches')">マッチング一覧</button>
                <button id="nav-profile" onclick="showTab('profile')">プロフィール編集</button>
            </nav>
            <div id="users-tab"><ul id="user-list" class="user-list"></ul></div>
            <div id="matches-tab" style="display: none;"><h2>マッチング成立！</h2><p>相互に「いいね」したユーザーです。</p><ul id="match-list" class="match-list"></ul></div>
            <div id="profile-tab" style="display: none;">
                <h2>プロフィール編集</h2>
                <p><strong>興味・関心タグ</strong></p>
                <div id="profile-interests-editor"></div><button onclick="updateProfile()">興味タグを更新</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyAcKf5BrhFFkv74WdaamqnrCY1qSRxsVjE",
          authDomain: "deaikei-kosen.firebaseapp.com",
          projectId: "deaikei-kosen",
          storageBucket: "deaikei-kosen.firebasestorage.app",
          messagingSenderId: "166298285211",
          appId: "1:166298285211:web:5381e5e419754e0376c23e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>
    <script>
        // ===============================================
        // アプリケーションのメインJavaScript
        // ===============================================
        let loggedInUserId = null;
        const allInterests = ["プログラミング", "機械学習", "電子工作", "設計", "実験", "ロボコン", "デザイン", "映像制作", "バスケ", "サッカー", "テニス", "音楽", "バンド", "TOIC勉強中", "論文執筆", "起業したい", "ボランティア", "バイク"];
        
        // ▼▼▼ ページ読み込み時の処理をメールリンク認証用に変更 ▼▼▼
        window.onload = function() {
            // メールリンクからのアクセスかチェック
            if (auth.isSignInWithEmailLink(window.location.href)) {
                let email = window.localStorage.getItem('emailForSignIn');
                if (!email) {
                    // 何らかの理由でメールアドレスが保存されていない場合、ユーザーに再入力を促す
                    email = window.prompt('認証を完了するため、メールアドレスを再度入力してください。');
                }
                
                // メールリンクを使ってログイン処理を完了させる
                auth.signInWithEmailLink(email, window.location.href)
                    .then(async (result) => {
                        window.localStorage.removeItem('emailForSignIn'); // 一時保存したメールを削除
                        const user = result.user;
                        
                        // このユーザーが新規登録かどうかをFirestoreで確認
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (!userDoc.exists) {
                            // 新規ユーザーなので、プロフィール設定画面を表示
                            showScreen('profile-setup-screen');
                        } else {
                            // 既存ユーザーなので、メイン画面を表示（onAuthStateChangedが後で処理）
                        }
                    })
                    .catch(error => alert('ログインに失敗しました: ' + error.message));
            }
        };

        // ログイン状態の監視（変更なし）
        auth.onAuthStateChanged(user => {
            if (user) {
                loggedInUserId = user.uid;
                // プロフィールがまだ設定されていない場合は、onAuthStateChangedでは何もしない
                db.collection('users').doc(user.uid).get().then(doc => {
                    if(doc.exists) {
                        showScreen('main-screen');
                        renderMainScreen();
                    }
                });
            } else {
                loggedInUserId = null;
                showScreen('login-screen');
            }
        });

        // ▼▼▼ 認証メールを送信する関数 ▼▼▼
        function sendSignInLink() {
            const email = document.getElementById('email-input').value.replace(/\s/g, '');
            if (!email) {
                alert('メールアドレスを入力してください。'); return;
            }
            if (!email.endsWith('@s.akashi.ac.jp')) {
                alert('登録できるのは "@s.akashi.ac.jp" のメールアドレスのみです。'); return;
            }

            const actionCodeSettings = {
                url: window.location.href, // 認証後に戻ってくるURL
                handleCodeInApp: true
            };

            auth.sendSignInLinkToEmail(email, actionCodeSettings)
                .then(() => {
                    // メール送信後、ユーザーがブラウザを閉じても大丈夫なようにメールアドレスを保存
                    window.localStorage.setItem('emailForSignIn', email);
                    alert(`認証用のリンクを ${email} に送信しました。メールを確認してください。`);
                })
                .catch(error => alert('メールの送信に失敗しました: ' + error.message));
        }

        // ▼▼▼ 初回プロフィールを登録する関数 ▼▼▼
        function handleProfileSetup() {
            const currentUser = auth.currentUser;
            if (!currentUser) {
                alert('ログイン情報が見つかりません。'); return;
            }
            
            const name = document.getElementById('register-name').value.trim();
            const faculty = document.getElementById('register-faculty').value;
            const grade = document.getElementById('register-grade').value;

            if (!name) { alert('ニックネームを入力してください。'); return; }

            db.collection('users').doc(currentUser.uid).set({
                uid: currentUser.uid, name: name, faculty: faculty,
                grade: grade, interests: []
            }).then(() => {
                alert('登録が完了しました！');
                showScreen('main-screen');
                renderMainScreen(); // メイン画面の描画をキック
            }).catch(error => alert('プロフィールの登録に失敗しました: ' + error.message));
        }
        
        function handleLogout() { auth.signOut(); }
        function renderMainScreen() { /* ... 変更なし ... */ }
        function renderUsers() { /* ... 変更なし ... */ }
        async function handleLike(targetUserId) { /* ... 変更なし ... */ }
        async function renderMatches() { /* ... 変更なし ... */ }
        function renderProfileEditor() { /* ... 変更なし ... */ }
        function updateProfile() { /* ... 変更なし ... */ }

        // 省略した関数の本体（コピー用）
        function showScreen(screenId) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(screenId).classList.add('active'); }
        function showTab(tabId) { ['users-tab', 'matches-tab', 'profile-tab'].forEach(id => document.getElementById(id).style.display = 'none'); document.getElementById(`${tabId}-tab`).style.display = 'block'; document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active')); document.getElementById(`nav-${tabId}`).classList.add('active'); if (tabId === 'users') renderUsers(); if (tabId === 'matches') renderMatches(); if (tabId === 'profile') renderProfileEditor(); }
        function renderMainScreen() { db.collection('users').doc(loggedInUserId).get().then(doc => { if (doc.exists) { document.getElementById('welcome-message').textContent = `ようこそ、${doc.data().name}さん！`; } }); showTab('users'); }
        function renderUsers() { const userList = document.getElementById('user-list'); userList.innerHTML = "<p>ユーザー情報を読み込み中...</p>"; db.collection('likes').where('from', '==', loggedInUserId).get().then(likeSnapshot => { const myLikes = likeSnapshot.docs.map(doc => doc.data().to); db.collection('users').onSnapshot(snapshot => { userList.innerHTML = ''; snapshot.forEach(doc => { const user = doc.data(); if (user.uid === loggedInUserId) return; const iLiked = myLikes.includes(user.uid); const card = document.createElement('li'); card.className = 'user-card'; card.innerHTML = `<h3>${user.name} <small>(${user.faculty}・${user.grade})</small></h3><div class="tags">${(user.interests || []).map(tag => `<span class="tag">${tag}</span>`).join('')}</div><button onclick="handleLike('${user.uid}')" ${iLiked ? 'disabled' : ''}>${iLiked ? '✅ いいね済み' : '👍 いいね！'}</button>`; userList.appendChild(card); }); }); }); }
        async function handleLike(targetUserId) { await db.collection('likes').add({ from: loggedInUserId, to: targetUserId }); renderUsers(); const query = db.collection('likes').where('from', '==', targetUserId).where('to', '==', loggedInUserId); const result = await query.get(); if (!result.empty) { const targetUserData = await db.collection('users').doc(targetUserId).get(); alert(`🎉 ${targetUserData.data().name}さんとマッチングしました！`); } }
        async function renderMatches() { const matchList = document.getElementById('match-list'); matchList.innerHTML = "<p>マッチング情報を読み込み中...</p>"; const myLikesSnapshot = await db.collection('likes').where('from', '==', loggedInUserId).get(); const myLikesIds = myLikesSnapshot.docs.map(doc => doc.data().to); const likedBySnapshot = await db.collection('likes').where('to', '==', loggedInUserId).get(); const likedByIds = likedBySnapshot.docs.map(doc => doc.data().from); const matchedIds = myLikesIds.filter(id => likedByIds.includes(id)); if (matchedIds.length === 0) { matchList.innerHTML = '<p>まだマッチングしたユーザーはいません。</p>'; return; } const usersSnapshot = await db.collection('users').where('uid', 'in', matchedIds).get(); matchList.innerHTML = ''; usersSnapshot.forEach(doc => { const user = doc.data(); const card = document.createElement('li'); card.className = 'user-card'; card.innerHTML = `<h3>${user.name} <small>(${user.faculty}・${user.grade})</small></h3><div class="tags">${(user.interests || []).map(tag => `<span class="tag">${tag}</span>`).join('')}</div>`; matchList.appendChild(card); }); }
        function renderProfileEditor() { const editor = document.getElementById('profile-interests-editor'); editor.innerHTML = "<p>プロフィール情報を読み込み中...</p>"; db.collection('users').doc(loggedInUserId).get().then(doc => { if (!doc.exists) return; const myInterests = doc.data().interests || []; editor.innerHTML = ''; allInterests.forEach(interest => { const isChecked = myInterests.includes(interest); editor.innerHTML += `<label><input type="checkbox" value="${interest}" ${isChecked ? 'checked' : ''}>${interest}</label>`; }); }); }
        function updateProfile() { const selectedInterests = []; document.querySelectorAll('#profile-interests-editor input:checked').forEach(c => selectedInterests.push(c.value)); db.collection('users').doc(loggedInUserId).update({ interests: selectedInterests }).then(() => { alert('プロフィールを更新しました！'); showTab('users'); }).catch(error => alert('更新に失敗しました: ' + error.message)); }
    </script>
</body>
</html>
