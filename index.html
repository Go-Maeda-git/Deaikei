<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uni-Link プロトタイプ (高専版)</title>
    <style>
        /* CSSはほぼ変更なし、モーダル用のスタイルを追加 */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #0056b3; }
        p.description { text-align: center; color: #6c757d; font-size: 0.9em; }
        .screen { display: none; }
        .screen.active { display: block; }
        input[type="email"], input[type="text"], input[type="password"], input[type="tel"], select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .secondary-button { background-color: #6c757d; margin-top: 10px; }
        .secondary-button:hover { background-color: #5a6268; }
        .logout-button { background-color: #dc3545; width: auto; float: right;}
        .user-list, .match-list { list-style: none; padding: 0; }
        .user-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 8px; background: #fff; }
        .user-card h3 { margin-top: 0; }
        .user-card .tags { margin-top: 10px; }
        .tag { display: inline-block; background-color: #e9ecef; color: #495057; padding: 3px 8px; margin: 2px; border-radius: 12px; font-size: 14px; }
        nav { display: flex; justify-content: space-around; border-bottom: 2px solid #007bff; margin-bottom: 20px; }
        nav button { background: none; border: none; color: #007bff; padding: 15px; font-size: 16px; cursor: pointer; width: 33.3%; border-radius: 0; }
        nav button.active { border-bottom: 3px solid #0056b3; font-weight: bold; }
        #profile-interests-editor { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        #profile-interests-editor label { display: flex; align-items: center; cursor: pointer; padding: 5px; border: 1px solid #ddd; border-radius: 5px; }
        /* SMSコード入力用モーダルのスタイル */
        dialog { border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); padding: 2em; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body>

    <div class="container">
        <!-- ログイン/登録画面は変更なし -->
        <div id="login-screen" class="screen active">
            <h1>Uni-Link</h1>
            <h2>高専内交流促進アプリ</h2>
            <input type="email" id="login-id" placeholder="学校のメールアドレス">
            <input type="password" id="login-password" placeholder="このアプリで登録したパスワード">
            <button onclick="handleLogin()">ログイン</button>
            <button class="secondary-button" onclick="showScreen('register-screen')">新規登録はこちら</button>
        </div>
        <div id="register-screen" class="screen">
            <h1>新規登録</h1>
            <p class="description">パスワードはGoogleアカウントのものとは別に、<br>このアプリ専用のものを設定してください。</p>
            <input type="email" id="register-id" placeholder="学校のメールアドレス (例: s20c123@s.akashi.ac.jp)">
            <input type="password" id="register-password" placeholder="パスワード (6文字以上)">
            <input type="text" id="register-name" placeholder="ニックネーム">
            <select id="register-faculty">
                <option value="機械工学科">M科 (機械工学科)</option>
                <option value="電気情報工学科">E科 (電気情報工学科)</option>
                <option value="都市システム工学科">C科 (都市システム工学科)</option>
                <option value="建築学科">A科 (建築学科)</option>
            </select>
            <select id="register-grade">
                <option value="1年">1年</option><option value="2年">2年</option><option value="3年">3年</option><option value="4年">4年</option><option value="5年">5年</option><option value="専攻科1年">専攻科1年</option><option value="専攻科2年">専攻科2年</option>
            </select>
            <button onclick="handleRegister()">登録する</button>
            <button class="secondary-button" onclick="showScreen('login-screen')">ログイン画面に戻る</button>
        </div>
        
        <!-- メイン画面 -->
        <div id="main-screen" class="screen">
            <button class="logout-button" onclick="handleLogout()">ログアウト</button>
            <h1 id="welcome-message">ようこそ！</h1>
            <nav>
                <button id="nav-users" class="active" onclick="showTab('users')">ユーザー一覧</button>
                <button id="nav-matches" onclick="showTab('matches')">マッチング一覧</button>
                <button id="nav-profile" onclick="showTab('profile')">プロフィール編集</button>
            </nav>
            <div id="users-tab"><ul id="user-list" class="user-list"></ul></div>
            <div id="matches-tab" style="display: none;">
                <h2>マッチング成立！</h2><p>相互に「いいね」したユーザーです。</p><ul id="match-list" class="match-list"></ul>
            </div>
            <!-- ▼▼▼ プロフィール編集画面にMFA登録UIを追加 ▼▼▼ -->
            <div id="profile-tab" style="display: none;">
                <h2>プロフィール編集</h2>
                <p><strong>興味・関心タグ</strong></p>
                <div id="profile-interests-editor"></div>
                <button onclick="updateProfile()">興味タグを更新</button>
                <hr style="margin: 2em 0;">
                <h2>多要素認証 (MFA)</h2>
                <div id="mfa-info"></div>
                <div id="mfa-enroll-section" style="display: none;">
                    <p>MFAを有効にするには、SMSが受信できる電話番号を登録してください。（例: +819012345678）</p>
                    <input type="tel" id="phone-number" placeholder="+81... (国番号から入力)">
                    <button id="enroll-mfa-button" onclick="enrollMfa()">電話番号を登録して認証コードを送信</button>
                    <!-- reCAPTCHAウィジェットが表示されるコンテナ -->
                    <div id="recaptcha-container" style="margin-top: 10px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ▼▼▼ SMSコード入力用のモーダルダイアログを追加 ▼▼▼ -->
    <dialog id="mfa-modal">
        <h2>SMSコードの入力</h2>
        <p>電話番号に送信された6桁の認証コードを入力してください。</p>
        <input type="text" id="mfa-code" placeholder="6桁のコード">
        <button id="mfa-submit-button">認証</button>
        <button id="mfa-cancel-button" class="secondary-button">キャンセル</button>
    </dialog>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script>
        // Firebase の初期化
        const firebaseConfig = {
          apiKey: "AIzaSyAcKf5BrhFFkv74WdaamqnrCY1qSRxsVjE",
          authDomain: "deaikei-kosen.firebaseapp.com",
          projectId: "deaikei-kosen",
          storageBucket: "deaikei-kosen.firebasestorage.app",
          messagingSenderId: "166298285211",
          appId: "1:166298285211:web:5381e5e419754e0376c23e"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
    </script>
    <script>
        // ===============================================
        // アプリケーションのメインJavaScript
        // ===============================================
        let loggedInUserId = null;
        // MFA処理中に使う一時的な変数
        let mfaResolver = null;

        const allInterests = ["プログラミング", "機械学習", "電子工作", "設計", "実験", "ロボコン", "デザイン", "映像制作", "バスケ", "サッカー", "テニス", "音楽", "バンド", "TOIC勉強中", "論文執筆", "起業したい", "ボランティア", "バイク"];

        // ログイン状態の監視
        auth.onAuthStateChanged(user => {
            if (user) {
                loggedInUserId = user.uid;
                showScreen('main-screen');
                renderMainScreen();
            } else {
                loggedInUserId = null;
                showScreen('login-screen');
            }
        });

        // 画面・タブ切り替え
        function showScreen(screenId) { /* ... 変更なし ... */ }
        function showTab(tabId) { /* ... 変更なし ... */ }

        // ユーザー認証関連
        function handleRegister() { /* ... 変更なし ... */ }

        // ▼▼▼ ログイン処理をMFA対応に大幅変更 ▼▼▼
        async function handleLogin() {
            const email = document.getElementById('login-id').value.replace(/\s/g, '');
            const password = document.getElementById('login-password').value;
            if (!email || !password) {
                alert('メールアドレスとパスワードを入力してください。'); return;
            }

            try {
                // 通常のログインを試行
                await auth.signInWithEmailAndPassword(email, password);
                // MFAが不要なら、onAuthStateChangedが呼ばれてログインが完了する
            } catch (error) {
                // MFAが必要な場合、特別なエラーが返ってくる
                if (error.code === 'auth/multi-factor-required') {
                    // MFA処理に必要な「解決者(resolver)」を取得
                    mfaResolver = error.resolver;
                    const phoneInfo = mfaResolver.hints[0]; // 登録済みの電話番号情報
                    alert(`二段階認証が必要です。登録済みの電話番号 (${phoneInfo.phoneNumber}) にSMSを送信します。`);
                    
                    const phoneAuthProvider = new firebase.auth.PhoneAuthProvider();
                    
                    // 見えないreCAPTCHAを準備
                    const verifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                        'size': 'invisible'
                    });

                    // SMSを送信
                    const verificationId = await phoneAuthProvider.verifyPhoneNumber(phoneInfo, verifier);
                    
                    // SMSコード入力モーダルを表示
                    const modal = document.getElementById('mfa-modal');
                    const submitBtn = document.getElementById('mfa-submit-button');
                    const cancelBtn = document.getElementById('mfa-cancel-button');
                    const codeInput = document.getElementById('mfa-code');

                    submitBtn.onclick = async () => {
                        const credential = firebase.auth.PhoneAuthProvider.credential(verificationId, codeInput.value);
                        try {
                            // MFA解決者とSMSコードを使って最終的なログインを試みる
                            await mfaResolver.resolveSignIn(firebase.auth.MultiFactorAssertion.from(credential));
                            modal.close(); // 成功したらモーダルを閉じる
                        } catch (e) {
                            alert('認証コードが正しくありません。');
                        }
                    };
                    cancelBtn.onclick = () => modal.close();
                    modal.showModal();

                } else {
                    console.error("Login Error:", error);
                    alert('メールアドレスまたはパスワードが間違っています。');
                }
            }
        }
        
        function handleLogout() { auth.signOut(); }
        function renderMainScreen() { /* ... 変更なし ... */ }
        function renderUsers() { /* ... 変更なし ... */ }
        async function handleLike(targetUserId) { /* ... 変更なし ... */ }
        async function renderMatches() { /* ... 変更なし ... */ }

        // ▼▼▼ プロフィール編集画面にMFA関連機能を追加 ▼▼▼
        function renderProfileEditor() {
            const editor = document.getElementById('profile-interests-editor');
            const mfaInfo = document.getElementById('mfa-info');
            const mfaEnrollSection = document.getElementById('mfa-enroll-section');

            // 興味タグの描画
            db.collection('users').doc(loggedInUserId).get().then(doc => { /* ... 変更なし ... */ });
            
            // MFA登録状態の表示
            const currentUser = auth.currentUser;
            if (currentUser && currentUser.multiFactor.enrolledFactors.length > 0) {
                const phone = currentUser.multiFactor.enrolledFactors[0].phoneNumber;
                mfaInfo.innerHTML = `<p>✅ 多要素認証は有効です。<br>登録中の電話番号: ${phone}</p>`;
                mfaEnrollSection.style.display = 'none';
            } else {
                mfaInfo.innerHTML = `<p>❌ 多要素認証はまだ有効になっていません。</p>`;
                mfaEnrollSection.style.display = 'block';
            }
        }

        // ▼▼▼ MFA（電話番号）を登録する新機能 ▼▼▼
        async function enrollMfa() {
            const phoneNumber = document.getElementById('phone-number').value;
            if (!phoneNumber) {
                alert('電話番号を入力してください。'); return;
            }

            const currentUser = auth.currentUser;
            try {
                const session = await currentUser.multiFactor.getSession();

                // 見えないreCAPTCHAを準備
                window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    'size': 'invisible'
                });

                const phoneInfoOptions = {
                    phoneNumber: phoneNumber,
                    session: session
                };
                
                const phoneAuthProvider = new firebase.auth.PhoneAuthProvider();
                const verificationId = await phoneAuthProvider.verifyPhoneNumber(phoneInfoOptions, window.recaptchaVerifier);

                const verificationCode = prompt('電話番号に送信された6桁の認証コードを入力してください。');
                if (!verificationCode) return;

                const credential = firebase.auth.PhoneAuthProvider.credential(verificationId, verificationCode);
                const multiFactorAssertion = firebase.auth.MultiFactorAssertion.from(credential);

                // ユーザーのMFAとして電話番号を登録
                await currentUser.multiFactor.enroll(multiFactorAssertion, 'My App Phone Number');

                alert('多要素認証の登録が完了しました！');
                renderProfileEditor(); // 表示を更新

            } catch (error) {
                console.error("MFA Enrollment Error:", error);
                alert('MFAの登録に失敗しました。\n' + error.message);
            }
        }

        function updateProfile() { /* ... 変更なし ... */ }

        // 変更がない関数の中身を省略して記載
        function showScreen(screenId) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(screenId).classList.add('active'); }
        function showTab(tabId) { ['users-tab', 'matches-tab', 'profile-tab'].forEach(id => document.getElementById(id).style.display = 'none'); document.getElementById(`${tabId}-tab`).style.display = 'block'; document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active')); document.getElementById(`nav-${tabId}`).classList.add('active'); if (tabId === 'users') renderUsers(); if (tabId === 'matches') renderMatches(); if (tabId === 'profile') renderProfileEditor(); }
        function handleRegister() { const email = document.getElementById('register-id').value.replace(/\s/g, ''); const password = document.getElementById('register-password').value; const name = document.getElementById('register-name').value.trim(); const faculty = document.getElementById('register-faculty').value; const grade = document.getElementById('register-grade').value; if (!email || !password || !name) { alert('メールアドレス, パスワード, ニックネームは必須です。'); return; } if (!email.endsWith('@s.akashi.ac.jp')) { alert('登録できるのは "@s.akashi.ac.jp" のメールアドレスのみです。'); return; } auth.createUserWithEmailAndPassword(email, password).then(userCredential => { const user = userCredential.user; db.collection('users').doc(user.uid).set({ uid: user.uid, name: name, faculty: faculty, grade: grade, interests: [] }).then(() => { alert('登録が完了しました！ログインしてください。'); showScreen('login-screen'); }); }).catch(error => { if (error.code === 'auth/weak-password') { alert('パスワードは6文字以上で設定してください。'); } else { alert('登録に失敗しました。\n' + error.message); } }); }
        function renderMainScreen() { db.collection('users').doc(loggedInUserId).get().then(doc => { if (doc.exists) { document.getElementById('welcome-message').textContent = `ようこそ、${doc.data().name}さん！`; } }); showTab('users'); }
        function renderUsers() { const userList = document.getElementById('user-list'); userList.innerHTML = "<p>ユーザー情報を読み込み中...</p>"; db.collection('likes').where('from', '==', loggedInUserId).get().then(likeSnapshot => { const myLikes = likeSnapshot.docs.map(doc => doc.data().to); db.collection('users').onSnapshot(snapshot => { userList.innerHTML = ''; snapshot.forEach(doc => { const user = doc.data(); if (user.uid === loggedInUserId) return; const iLiked = myLikes.includes(user.uid); const card = document.createElement('li'); card.className = 'user-card'; card.innerHTML = `<h3>${user.name} <small>(${user.faculty}・${user.grade})</small></h3><div class="tags">${(user.interests || []).map(tag => `<span class="tag">${tag}</span>`).join('')}</div><button onclick="handleLike('${user.uid}')" ${iLiked ? 'disabled' : ''}>${iLiked ? '✅ いいね済み' : '👍 いいね！'}</button>`; userList.appendChild(card); }); }); }); }
        async function handleLike(targetUserId) { await db.collection('likes').add({ from: loggedInUserId, to: targetUserId }); renderUsers(); const query = db.collection('likes').where('from', '==', targetUserId).where('to', '==', loggedInUserId); const result = await query.get(); if (!result.empty) { const targetUserData = await db.collection('users').doc(targetUserId).get(); alert(`🎉 ${targetUserData.data().name}さんとマッチングしました！`); } }
        async function renderMatches() { const matchList = document.getElementById('match-list'); matchList.innerHTML = "<p>マッチング情報を読み込み中...</p>"; const myLikesSnapshot = await db.collection('likes').where('from', '==', loggedInUserId).get(); const myLikesIds = myLikesSnapshot.docs.map(doc => doc.data().to); const likedBySnapshot = await db.collection('likes').where('to', '==', loggedInUserId).get(); const likedByIds = likedBySnapshot.docs.map(doc => doc.data().from); const matchedIds = myLikesIds.filter(id => likedByIds.includes(id)); if (matchedIds.length === 0) { matchList.innerHTML = '<p>まだマッチングしたユーザーはいません。</p>'; return; } const usersSnapshot = await db.collection('users').where('uid', 'in', matchedIds).get(); matchList.innerHTML = ''; usersSnapshot.forEach(doc => { const user = doc.data(); const card = document.createElement('li'); card.className = 'user-card'; card.innerHTML = `<h3>${user.name} <small>(${user.faculty}・${user.grade})</small></h3><div class="tags">${(user.interests || []).map(tag => `<span class="tag">${tag}</span>`).join('')}</div>`; matchList.appendChild(card); }); }
        function updateProfile() { const selectedInterests = []; document.querySelectorAll('#profile-interests-editor input:checked').forEach(c => selectedInterests.push(c.value)); db.collection('users').doc(loggedInUserId).update({ interests: selectedInterests }).then(() => { alert('プロフィールを更新しました！'); showTab('users'); }).catch(error => alert('更新に失敗しました: ' + error.message)); }
    </script>
</body>
</html>
